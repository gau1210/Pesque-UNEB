<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PESQUE-UNEB</title>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
<link href="/static/css/estilo.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
<div align="center">
  <div style="width:700px">
  <div style="margin-top:20px; text-align:left">
    <p align="center"><h1>PESQUE-UNEB </h1></p>
    <form method="get" action="">
    <input type="text" name="search" id="search_box" class='search_box'/>
    <input type="submit" value="Buscar" class="search_button" /><br />
    <span style="color:#666666; font-size:14px; font-family:Arial, Helvetica, sans-serif;"><b>Ex:</b>Sistemas de informação</span>
    </form>
    <div id="autoCompleteList"></div> <!-- Elemento para exibir as sugestões -->
  </div>
  <div>
    <div id="searchword">Resultados da pesquisa para: <span class="searchword"></span></div>
    <div id="flash"></div>
    <ol id="insert_search" class="update"></ol>
  </div>
  </div>
</div>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script>
$(document).ready(function() {
    var selections = []; // Array para armazenar todas as seleções

    // Evento de clique em uma sugestão
    $("#autoCompleteList").on('click', 'li', function() {
        var autoCompleteText = $(this).text(); // Obtém o texto da sugestão
        replaceWordBeforeCursor(autoCompleteText); // Substitui o termo antes do cursor pelo texto selecionado
        selections.push(autoCompleteText); // Adiciona a seleção ao array
        $("#autoCompleteList").empty(); // Limpa a lista de sugestões
    });

    // Função para substituir o termo antes do cursor pelo texto selecionado
    function replaceWordBeforeCursor(text) {
        var field = $("#search_box")[0]; // Obtém o campo de busca como um elemento DOM
        var startPos = field.selectionStart; // Obtém a posição inicial do cursor
        var endPos = field.selectionEnd; // Obtém a posição final do cursor
        var value = field.value; // Obtém o valor atual do campo de busca

        // Encontra o início do termo anterior ao cursor
        var startOfWord = value.lastIndexOf(' ', startPos - 1);
        startOfWord = startOfWord === -1 ? 0 : startOfWord + 1; // Trata o caso em que não há espaços antes do cursor

        // Encontra o final do termo anterior ao cursor
        var endOfWord = value.indexOf(' ', startPos);
        endOfWord = endOfWord === -1 ? value.length : endOfWord;

        // Substitui o termo antes do cursor pelo novo texto selecionado
        var newValue = value.substring(0, startOfWord) + text + value.substring(endOfWord, value.length);

        field.value = newValue; // Atualiza o valor do campo de busca
        field.focus(); // Coloca o foco de volta no campo de busca
        field.setSelectionRange(startOfWord + text.length, startOfWord + text.length); // Define a posição do cursor após a substituição
    }

    // Evento de digitação no campo de busca
    $("#search_box").on('input', function(e) {
        var search_word = $(this).val().trim(); // Remove espaços em branco antes e depois do termo de pesquisa
        
        // Atualiza o atributo placeholder com a sugestão atual
        $(this).attr('placeholder', 'Ex: ' + search_word);
        
        // Verifica se o termo de pesquisa está vazio
        if (search_word == '') {
            // Limpa a array de seleções apenas se o campo de busca estiver vazio
            if (selections.length > 0) {
                selections = [];
            }
            $("#autoCompleteList").empty(); // Limpa a lista de sugestões
        } else {
            $.ajax({
                type: "GET",
                url: "/autocomplete",
                data: { term: search_word }, // Envia o termo de pesquisa para o servidor Flask
                success: function(response) {
                    var autoCompleteList = $("#autoCompleteList");
                    autoCompleteList.empty(); // Limpa a lista de sugestões

                    // Adiciona cada sugestão à lista de sugestões
                    response.forEach(function(suggestion) {
                        autoCompleteList.append('<li class="list-group-item">' + suggestion + '</li>');
                    });

                    // Exibe a lista de sugestões
                    autoCompleteList.show();
                }
            });
        }
    });

    // Evento de clique no botão de busca
    $(".search_button").click(function() {
        var search_word = $("#search_box").val().trim(); // Remove espaços em branco antes e depois do termo de pesquisa
        var dataString = 'search_word=' + encodeURIComponent(search_word); // Codificar o termo de pesquisa para evitar erros de caracteres especiais
        
        if (search_word == '') {
            // Se a caixa de busca estiver vazia, não faça nada.
        } else {
            $.ajax({
                type: "POST",
                url: "/searchdata",
                data: dataString,
                cache: false,
                beforeSend: function(html) {
                    document.getElementById("insert_search").innerHTML = '';
                    $("#flash").show();
                    $("#searchword").show();
                    $(".searchword").html(search_word);
                    $("#flash").html('<img src="/static/img/loader.gif" align="absmiddle"> Carregando Resultados...');
                },
                success: function(html) {
                    $("#insert_search").show();
                    $("#insert_search").append(html.data);
                    // Adiciona o link de download do CSV
                    if (html.csv_url) {
                        var downloadButton = '<a href="' + html.csv_url + '" class="btn btn-primary" type="button">Baixar CSV <i class="fa fa-file-csv"></i></a>';
                        $("#insert_search").append(downloadButton);
                    }
                    $("#flash").hide();

                    // Evento de clique para cada item da lista de resultados
                    $(".show-details").click(function() {
                        var id = $(this).data('id');
                        $.ajax({
                            type: 'GET',
                            url: '/get_details/' + id, // Rota Flask para recuperar detalhes do registro
                            success: function(data) {
                                $('#detailsBody').html(data);
                                $('#detailsModal').modal('show'); // Mostrar o modal com os detalhes
                            },
                            error: function(xhr, status, error) {
                                alert('Erro ao recuperar detalhes do registro');
                            }
                        });
                    });

                    // Evento de clique para fechar o modal quando o botão de fechar é clicado
                    $('#detailsModal').on('click', '.close', function() {
                        $('#detailsModal').modal('hide'); // Oculta o modal
                    });
                }
            });
        }
        return false;
    });

    // Evento de tecla para detectar quando a tecla Backspace é pressionada
    $("#search_box").on('keydown', function(e) {
        if (e.keyCode === 8) { // 8 é o código da tecla Backspace
            // Limpa a array de seleções apenas se o campo de busca estiver vazio
            if ($(this).val() === '') {
                selections = [];
            }
        }
    });
});
</script>
</body>
</html>

